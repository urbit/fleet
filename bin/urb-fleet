#!/bin/bash
set -e

if hash gstat 2>/dev/null; then  # Mac workaround
  alias stat=gstat
fi
alias urb="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"/urb # XX gnuism

SPAM_SHIPS='TRAP' # XX should this really be a global?
spam (){
  if [ "$SPAM_SHIPS" == 'TRAP' ]; then
    echo "Called 'spam' without setting target ships"
    exit 1
  fi
  for ship in $SPAM_SHIPS
  do
    echo urb $ship $@
    urb $ship "$@" &
  done
  for job in `jobs -p`
  do
    wait $job
  done
}

self (){
  command=$1
  shift
  case $command in
      (urb-fleet)
    #
    self $@
  ;;
      (wait-ship)
    for ship; do
      ports=$ship/.urb/.http.ports
      prev=$([ ! -f $ports ] || stat -c %Y $ports)
      until [ -f $ports ] && [ "$prev" != "$(stat -c %y $ports)"  ]; do sleep 1; done
      echo Found $ports
      until [ -d $ship/home ]; do sleep 1; done
      echo Found $ship/home
    done
  ;;
      (join)
    chan=$1
    shift
    SPAM_SHIPS=$@
    spam -p talk -d "+talk/federate %porch [(sein our) $chan]"
  ;;
      (federate)
    chan=$1
    shift
    SPAM_SHIPS=$@
    spam -p talk -d "+talk/federate %$chan"
    spam -p talk -d \
      "+talk/federate %$chan$(for ship; do echo -n ' [~'$ship' %'$chan']'; done)"
  ;;
      (start)
    #
    FAKE_ARG=""
    ARVO=""
    SESSION_ARG=""
    while getopts "FA:S:C:" opt; do
      case $opt in
      (F) FAKE_ARG="-F"
      ;; (A) ARVO="$OPTARG"
      ;; (S) SESSION_ARG="-S $OPTARG"
      ;; (C) cd "$OPTARG"
      esac
      shift "$((OPTIND - 1))"
    done
    for ship
    do
      if [ ! "$SESSION_ARG" ]; then
        urbit $FAKE_ARG $(self ship-args $ship)
      else
        self in-screen $ship urbit $FAKE_ARG $(self ship-args $ship)
      fi
    done
  ;;
      (in-screen)
    ship=$1
    shift
    S="$SESSION_ARG"
    if ! screen $S -Q 'select' - >/dev/null; then
      screen $S -m -d
    fi
    screen $S -Q 'select' $ship >/dev/null && screen $S -X 'kill'
    screen $S -X 'screen' -t $ship
    screen $S -X 'stuff' "$(printf '%s ' $@)\n"
    self wait-ship $ship
  ;;
      (ship-args)
    ship=$1
    echo >&2 Starting $ship
    args='TRAP'
    if [ 3 = ${#ship} ]; then
      args="-I $ship $ship"
      if [ ! -d $ship ]; then
        if [ "$ARVO" ]; then
          args="-G 0w0 -cA $ARVO $args"
        else
          echo >&2 "No -A for new galaxy"
          exit 1
        fi
      fi
    elif [ 6 = ${#ship} ] || [ 13 = ${#ship} ] ; then
      if [ -d $ship ]; then args="$ship"
      else
        sein=$(\
          env LENS_PORT=12321 `# XX figure out port`\
          urb -d "(sein ~$ship)")
        if [ ! -d ${sein:1} ]; then
          self start ${sein:1}
        fi
        ticket=$(urb ${sein:1} -d "+ticket ~$ship")
        #
        args="-cw $ship -t $ticket"
      fi
    else
      echo >&2 "Weird ship $ship, length ${#ship}"
      exit 1
    fi
    echo $args
  ;;
      (children)
    count=$1
    shift
    for n in `seq 1 $count`
    do
      for ship
      do
        NEIS='|=(a/@u ^-(@p (rep (max 3 (xeb (xeb our))) our a ~)))'
        urb $ship -d "_$NEIS 0i$n" | sed s/.// # strip leading ~
      done
    done
  ;;
      (*)
    echo >&2 "Unknown command: $command"
    exit 1
  ;;
  esac
}
self "$(basename $0)" $@
