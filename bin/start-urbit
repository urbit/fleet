#!/bin/bash
fleet_bin="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
set -e
ship=$1
shift

if ! which screen >/dev/null; then
  printf "Error: GNU screen is not installed"
  exit 1
fi

if screen -S $ship -X select .; then
  printf "Killing previous screen session for $ship\n"
  screen -X -S $ship quit
fi

printf "Booting Urbit in new screen session\n"
screen -dmS $ship
screen -S $ship -X stuff "$fleet_bin/urbit $(printf '%s ' $@)\n"
printf "Launched ship in screen window: $ship\n"

# previous invocation of ship would have created the ports file already,
# so wait until it gets rewritten by the new urbit process.
$fleet_bin/wait/next ships/$ship/.http.ports

if [ ! -d ships/$ship/home ]; then
  screen -S $ship -X stuff "|mount %\r\n"
  $fleet_bin/wait/for ships/$ship/home
fi

printf "Ship ~$ship running.\n"
